# Protocol Execution Guide

## Overview

The Protocol Execution system allows you to execute JSON protocol files that were generated by the learning system. These protocols contain a series of steps (intents) that automate Logic Pro operations.

## How It Works

1. **Learning Phase**: The system records your actions in Logic Pro and generates a JSON protocol file
2. **Play Phase**: The Protocol Executor reads the JSON file and replays the actions automatically

## JSON Protocol Format

```json
{
  "protocol": "protocol_name",
  "description": "Description of what this protocol does",
  "tags": ["tag1", "tag2", "tag3"],
  "steps": [
    {
      "intent": "intent_name",
      "parameters": { "param1": "value1", "param2": 123 }
    }
  ]
}
```

## Supported Intents

### Track Operations
- `select_track`: Select a track by number
  - Parameters: `track_number` (int)
- `create_track`: Create a new track
  - Parameters: `type` (string, optional)

### Region Operations
- `create_region`: Create a MIDI or audio region
  - Parameters: `type` (string), `length_bars` (int)
- `quantize_region`: Quantize a region
  - Parameters: `grid` (string), `strength` (int)
- `move_region`: Move a region to a new position
  - Parameters: `position` (object with x, y coordinates)
- `resize_region`: Resize a region
  - Parameters: `size` (object with width, height)

### Import Operations
- `import_chords`: Import chord progressions
  - Parameters: `folder` (string), `random` (boolean)
- `import_midi`: Import MIDI files
  - Parameters: `filename` (string), `track_number` (int, optional)

### Playback Operations
- `play`: Start playback
  - Parameters: `from_bar` (int, optional)
- `stop`: Stop playback
- `record`: Start recording
  - Parameters: `track_number` (int, optional)

### Project Operations
- `set_tempo`: Set project tempo
  - Parameters: `tempo` (int)
- `set_key`: Set key signature
  - Parameters: `key` (string)
- `save_project`: Save the project
  - Parameters: `filename` (string, optional)

### Advanced Operations
- `set_region_property`: Set region properties
  - Parameters: `property` (string), `value` (any)
- `apply_effect`: Apply effects to tracks
  - Parameters: `effect` (string), `track_number` (int, optional), `preset` (string, optional)
- `set_track_property`: Set track properties
  - Parameters: `property` (string), `value` (any), `track_number` (int, optional)

### Utility Operations
- `wait`: Add delays between steps
  - Parameters: `duration` (number), `unit` (string: "milliseconds", "seconds", "minutes")
- `log`: Add log messages
  - Parameters: `message` (string), `level` (string, optional)

## Using the Protocol Executor

### 1. Load a Protocol File
- Click "Load Protocol File" button
- Select a JSON protocol file from your file system
- The protocol will be parsed and displayed in the preview section

### 2. Review the Protocol
- Check the protocol name, description, and tags
- Review the list of steps that will be executed
- Optionally edit the JSON directly using the "Edit JSON" button

### 3. Execute the Protocol
- Click "Execute Protocol" button
- Monitor the execution progress in real-time
- View detailed execution logs
- Check the results when execution completes

### 4. View Results
- See overall execution statistics
- Review individual step results
- Click "Show Details" for comprehensive execution report

## Error Handling

The system includes robust error handling:

- **Critical Errors**: Stop execution (e.g., Logic Pro not running, accessibility not enabled)
- **Non-Critical Errors**: Continue execution with warnings
- **Step-Level Errors**: Individual step failures are logged but don't stop the entire protocol

## Best Practices

### Creating Protocols
1. Keep protocols focused on specific workflows
2. Use descriptive names and descriptions
3. Add relevant tags for organization
4. Test protocols in a safe environment first

### Executing Protocols
1. Ensure Logic Pro is running and accessible
2. Close any unsaved work before execution
3. Monitor the execution log for any issues
4. Have a backup of your project before running complex protocols

### Troubleshooting
1. Check that all required parameters are provided
2. Verify Logic Pro is in the expected state
3. Review execution logs for specific error messages
4. Test individual steps if a protocol fails

## Example Protocols

### Simple Chord Creation
```json
{
  "protocol": "create_chord_region",
  "description": "Creates a MIDI region and inserts chords",
  "tags": ["midi", "harmony", "workflow"],
  "steps": [
    {
      "intent": "select_track",
      "parameters": { "track_number": 1 }
    },
    {
      "intent": "create_region",
      "parameters": { "type": "MIDI", "length_bars": 4 }
    },
    {
      "intent": "import_chords",
      "parameters": { "folder": "ChordProgressions", "random": true }
    },
    {
      "intent": "quantize_region",
      "parameters": { "grid": "1/16", "strength": 90 }
    }
  ]
}
```

### Complete Song Setup
```json
{
  "protocol": "create_complete_song",
  "description": "Creates a complete song with multiple tracks and effects",
  "tags": ["song", "production", "workflow"],
  "steps": [
    {
      "intent": "set_tempo",
      "parameters": { "tempo": 120 }
    },
    {
      "intent": "create_track",
      "parameters": { "type": "Software Instrument" }
    },
    {
      "intent": "select_track",
      "parameters": { "track_number": 1 }
    },
    {
      "intent": "create_region",
      "parameters": { "type": "MIDI", "length_bars": 8 }
    },
    {
      "intent": "apply_effect",
      "parameters": { "effect": "Reverb", "track_number": 1 }
    }
  ]
}
```

## Current Implementation Status

### âœ… Completed Features
- **JSON Protocol Parsing**: Full support for parsing protocol files
- **Intent Handler System**: 20+ intent handlers implemented
- **Execution Engine**: Step-by-step execution with error handling
- **UI Integration**: Complete SwiftUI interface with progress tracking
- **Logging System**: Comprehensive execution logging
- **Error Handling**: Robust error handling and recovery
- **Real Logic Pro Integration**: `select_track` intent now performs actual track selection in Logic Pro

### ðŸ”„ Current Limitations
- **Partial Logic Pro Integration**: Only `select_track` intent is fully implemented
- **Other Intents**: Most intent handlers still log actions instead of executing them
- **Accessibility API**: Full Logic Pro control requires more intent implementations

### ðŸš€ Next Steps for Full Implementation
1. **Implement More Intents**: Connect remaining intent handlers to actual Logic Pro operations
2. **Test with Real Logic Pro**: Verify all operations work with actual Logic Pro
3. **Add More Intents**: Expand the intent library based on user needs
4. **Performance Optimization**: Optimize execution speed and reliability

### ðŸŽ¯ Recently Implemented
- **select_track Intent**: Now performs real track selection using keyboard navigation
  - Activates Logic Pro
  - Navigates to track list using Cmd+Home
  - Moves down to specified track using arrow keys
  - Includes comprehensive error handling and logging

## Integration with Learning System

The Protocol Executor is designed to work seamlessly with the learning system:

1. **Record**: Use the "Learning" tab to record your actions
2. **Save**: Save the recorded session as a protocol file
3. **Execute**: Use the "Protocol Execution" tab to replay the protocol

This creates a complete workflow from learning to automation, making Logic Pro workflows more efficient and repeatable.

## Testing the System

You can test the protocol execution system using the provided test files:

1. **simple_test_protocol.json**: Basic test with logging and wait operations
2. **test_protocol.json**: Chord creation workflow
3. **advanced_test_protocol.json**: Complex multi-step workflow

These test files will help you verify that the system is working correctly before implementing full Logic Pro integration.
